<!--
SINGLE-FILE HTML RULE: All code, styles, and assets must be embedded in this file.
MODULARITY RULE: Build features in a modular, maintainable way. Avoid bloat and conflicting code.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Glittercloud Adventure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #181818; }
    body { width: 100vw; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
    #game-container { position: relative; width: 100vw; height: 100vh; }
    #game-canvas { width: 100%; height: 100%; background: #222; display: block; }
    #hud { position: absolute; top: 10px; left: 10px; color: #fff; z-index: 10; }
    #start-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: url('https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/GlitterStart-eWtnNjTcWxXyheoQtPcBK9MDLQWYBK.png?koxn') center center/cover no-repeat;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 1000;
      transition: opacity 0.3s;
    }
    #start-overlay.hidden { opacity: 0; pointer-events: none; }
    #start-content {
      margin-top: 50vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      transform: translateY(-50%);
    }
    #start-title {
      font-size: 2.6em;
      font-family: 'Monoton', 'Courier New', monospace;
      text-align: center;
      color: #edd628;
      text-shadow: 0 0 7px #9932cc, 0 0 10px #9932cc, 0 0 21px #9932cc, 0 0 42px #9932cc;
      margin-bottom: 12px;
      letter-spacing: 2px;
      animation: glow 2s ease-in-out infinite alternate;
    }
    #start-btn {
      background: linear-gradient(135deg, rgba(153,50,204,0.8) 0%, rgba(153,50,204,0.4) 100%);
      border: 2px solid #9932cc;
      color: #edd628;
      font-family: 'Courier New', monospace;
      font-size: 1.3em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 0 0 10px #000, 0 0 20px #000, 0 0 30px #9932cc;
      box-shadow: 0 0 20px rgba(153,50,204,0.5);
      border-radius: 25px;
      min-width: 200px;
      text-align: center;
      padding: 15px 30px;
      outline: none;
      margin-bottom: 24px;
      animation: buttonPulse 2s infinite;
    }
    #start-btn:hover {
      background: linear-gradient(135deg, rgba(153,50,204,1) 0%, rgba(153,50,204,0.6) 100%);
      transform: scale(1.05);
      text-shadow: 0 0 20px #000, 0 0 30px #000, 0 0 40px #9932cc;
      box-shadow: 0 0 30px rgba(153,50,204,0.7);
    }
    #start-credit {
      color: #fff;
      font-size: 0.9em;
      opacity: 0.7;
      text-shadow: 1px 1px 8px #000;
    }
    /* Cutscene Styles */
    #cutscene-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      display: none;
      z-index: 2000;
    }
    #cutscene-bg {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background-size: cover;
      background-position: center;
      opacity: 1;
      z-index: 0;
      transition: background-image 0.6s;
    }
    #cutscene-textbox {
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 100vw;
      max-width: 100vw;
      height: 35vh;
      min-height: unset;
      max-height: 35vh;
      overflow-y: auto;
      background: rgba(0,0,0,0.85);
      box-shadow: 0 -4px 32px #000a;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      padding: 24px 32px 16px 32px;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
    }
    #cutscene-text {
      color: #0ff;
      font-family: 'Courier New', monospace;
      font-size: 1.25em;
      text-align: left;
      width: 100%;
      max-width: 900px;
      min-height: 2.5em;
      margin: 0 auto 12px auto;
      text-shadow: 2px 2px 8px #000;
      letter-spacing: 0.5px;
      line-height: 1.3;
      opacity: 1;
      transition: opacity 0.3s;
      word-break: break-word;
    }
    #cutscene-text.galaxander {
      font-size: 0.95em;
    }
    #cutscene-skip {
      color: #0ff;
      font-size: 1em;
      opacity: 0.7;
      margin-top: 8px;
      animation: pulse 1.5s infinite;
      user-select: none;
      text-align: right;
      width: 100%;
      max-width: 900px;
    }
    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 0.3; }
      100% { opacity: 0.7; }
    }
    @keyframes glow {
      from {
        text-shadow: 0 0 7px #9932cc, 0 0 10px #9932cc, 0 0 21px #9932cc, 0 0 42px #9932cc;
      }
      to {
        text-shadow: 0 0 10px #9932cc, 0 0 20px #9932cc, 0 0 30px #9932cc, 0 0 50px #9932cc;
      }
    }
    @keyframes buttonPulse {
      0% {
        box-shadow: 0 0 20px rgba(153,50,204,0.5);
      }
      50% {
        box-shadow: 0 0 30px rgba(153,50,204,0.7);
      }
      100% {
        box-shadow: 0 0 20px rgba(153,50,204,0.5);
      }
    }
    /* --- Menu Overlay Styles (inspired by gcaworking.html, clean version) --- */
    #menu-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.95);
      z-index: 3000;
      display: none;
      font-family: 'Luminari', 'Georgia', serif;
    }
    #menu-overlay.open {
      display: flex !important;
    }
    #menu-content {
      background: rgba(0,0,0,0.97);
      border: 2px solid #00ffff;
      box-shadow: 0 0 20px #00ffff44;
      color: #00ffff;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px 24px;
      border-bottom: 2px solid #00ffff44;
      background: rgba(0,255,255,0.05);
    }
    .menu-title {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 18px;
    }
    .menu-portrait {
      width: 114px;
      height: 114px;
      border-radius: 8px;
      border: 2px solid #00ffff;
      background: #111;
      object-fit: cover;
      display: block;
    }
    .menu-portrait-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 4px;
    }
    .menu-portrait-nav button {
      background: none;
      border: none;
      color: #00ffff;
      cursor: pointer;
      font-size: 1.1em;
      padding: 2px 6px;
      border-radius: 2px;
      transition: background 0.2s, color 0.2s;
      min-width: 0;
      min-height: 0;
      line-height: 1;
    }
    .menu-portrait-nav button:hover {
      background: #00ffff22;
      color: #fff;
    }
    .menu-title-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .menu-header-info {
      margin-left: 0;
      word-break: break-word;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 12px;
      align-items: start;
      font-size: 0.97em;
    }
    .menu-header-info > div {
      white-space: nowrap;
      font-size: 0.97em;
    }
    .menu-header-info .menu-stat-label {
      color: #00ffff;
      font-weight: bold;
      margin-right: 4px;
    }
    .menu-header-info .menu-stat-value {
      color: #fff;
    }
    .menu-card-title {
      color: #fff;
      font-size: 1.2em;
      text-shadow: 0 0 10px #00ffff;
      margin-bottom: 8px;
    }
    .menu-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      font-size: 0.95em;
    }
    .gold-value {
      color: #edd628;
      font-weight: bold;
    }
    .menu-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: rgba(0,255,255,0.03);
      border-radius: 4px;
    }
    .menu-stat-label {
      color: #fff;
      opacity: 0.8;
    }
    .menu-stat-value {
      color: #00ffff;
      font-weight: bold;
    }
    .derived-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 8px;
      font-size: 0.93em;
    }
    .stat-points-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }
    .menu-close-btn {
      background: none;
      border: none;
      color: #00ffff;
      font-size: 1.5em;
      cursor: pointer;
      transition: all 0.2s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
      line-height: 1;
    }
    .menu-close-btn:hover {
      color: #fff;
      text-shadow: 0 0 15px #00ffff;
      transform: scale(1.1);
    }
    .menu-content-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .menu-main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 24px;
      gap: 16px;
    }
    .menu-sidebar {
      width: 300px;
      border-left: 2px solid #00ffff44;
      background: rgba(0,255,255,0.03);
      padding: 24px;
      overflow-y: auto;
    }
    .menu-card {
      background: rgba(0,255,255,0.05);
      border: 1px solid #00ffff44;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .menu-card-title {
      color: #fff;
      font-size: 1.2em;
      margin-bottom: 12px;
      text-shadow: 0 0 10px #00ffff;
    }
    .menu-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .menu-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: rgba(0,255,255,0.03);
      border-radius: 4px;
    }
    .menu-stat-label {
      color: #fff;
      opacity: 0.8;
    }
    .menu-stat-value {
      color: #00ffff;
      font-weight: bold;
    }
    .menu-progress-bar {
      height: 8px;
      background: rgba(0,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 4px 0;
    }
    .menu-progress-fill {
      height: 100%;
      background: #00ffff;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .menu-tabs {
      display: flex;
      width: 100%;
      border-top: 2px solid #00ffff44;
      background: rgba(0,255,255,0.03);
      margin: 0;
      padding: 0;
      font-size: 0.95em;
      gap: 0;
      justify-content: space-between;
    }
    .menu-tab-btn {
      flex: 1;
      background: none;
      border: none;
      color: #00ffff;
      padding: 10px 4px;
      font-size: 0.95em;
      cursor: pointer;
      text-align: center;
      border-top: 2px solid transparent;
      transition: all 0.2s;
      outline: none;
      min-width: 0;
      letter-spacing: 0.01em;
    }
    .menu-tab-btn:hover {
      background: rgba(0,255,255,0.1);
    }
    .menu-tab-btn.active {
      border-top: 2px solid #00ffff;
      color: #fff;
      background: rgba(0,255,255,0.15);
      text-shadow: 0 0 10px #00ffff;
    }
    .menu-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .menu-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(0,255,255,0.03);
      border: 1px solid #00ffff22;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .menu-list-item:hover {
      background: rgba(0,255,255,0.08);
      border-color: #00ffff44;
    }
    .menu-list-item.selected {
      background: rgba(0,255,255,0.15);
      border-color: #00ffff;
    }
    .menu-detail {
      background: rgba(0,255,255,0.05);
      border: 1px solid #00ffff44;
      border-radius: 8px;
      padding: 16px;
    }
    .menu-detail-title {
      color: #fff;
      font-size: 1.2em;
      margin-bottom: 12px;
      text-shadow: 0 0 10px #00ffff;
    }
    .menu-detail-content {
      color: #00ffff;
      line-height: 1.4;
    }
    @media (max-width: 600px) {
      #menu-content { min-width: 90vw; min-height: 60vh; padding: 0; }
      .menu-tab-content { padding: 10px 6px 0 6px; }
    }
    #menu-overlay, #menu-content, .menu-content-wrapper, .menu-main-content {
      height: 100vh;
      max-height: 100vh;
      box-sizing: border-box;
    }
    #menu-content {
      padding-bottom: 0;
    }
    .menu-main-content {
      padding: 12px 8px 0 8px;
      gap: 8px;
      font-size: 0.97em;
    }
    .menu-card-title, .menu-detail-title {
      font-size: 1.05em;
      margin-bottom: 6px;
    }
    .menu-stats-grid, .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      font-size: 0.95em;
    }
    .stat-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(0,255,255,0.03);
      border-radius: 4px;
      padding: 2px 2px 2px 2px;
      min-width: 0;
    }
    .stat-label {
      color: #fff;
      font-size: 0.92em;
      margin-bottom: 1px;
    }
    .stat-controls {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .stat-button {
      background: none;
      border: 1px solid #00ffff44;
      color: #00ffff;
      font-size: 0.95em;
      width: 18px;
      height: 18px;
      border-radius: 3px;
      cursor: pointer;
      padding: 0;
      margin: 0 1px;
      line-height: 1;
      transition: background 0.15s;
    }
    .stat-button:disabled {
      color: #008080;
      border-color: #00808044;
      cursor: not-allowed;
      background: rgba(0,255,255,0.04);
    }
    .stat-value {
      color: #fff;
      font-size: 0.97em;
      min-width: 18px;
      text-align: center;
      display: inline-block;
    }
    .stat-points-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin: 4px 0 0 0;
      font-size: 0.97em;
    }
    .stat-points-label {
      color: #fff;
      font-size: 0.97em;
    }
    .stat-points-value {
      color: #edd628;
      font-weight: bold;
      font-size: 1.05em;
    }
    .stat-confirm-btn {
      background: #00ffff22;
      border: 1px solid #00ffff;
      color: #fff;
      font-size: 0.97em;
      border-radius: 4px;
      padding: 2px 10px;
      margin-left: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .stat-confirm-btn:disabled {
      color: #008080;
      border-color: #00808044;
      background: rgba(0,255,255,0.04);
      cursor: not-allowed;
    }
    /* --- Add new class for portrait+nav+class row --- */
    .menu-portrait-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 18px;
    }
    .menu-portrait-nav-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }
    .menu-class-label {
      margin-left: 12px;
      color: #00ffff;
      font-weight: bold;
    }
    .menu-class-value {
      color: #fff;
      font-weight: bold;
    }
    .menu-header-info {
      margin-left: 0;
      word-break: break-word;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 12px;
      align-items: start;
      font-size: 0.97em;
    }
    .menu-header-info > div {
      white-space: nowrap;
      font-size: 0.97em;
    }
    /* --- Add new class for hidden tab/content --- */
    .menu-tab-content.hidden {
      display: none;
    }
    .menu-sidebar.hidden {
      display: none;
    }
    .menu-detail-close {
      float: right;
      background: none;
      border: none;
      color: #00ffff;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 8px;
    }
    /* --- Add new class for debug overlay and related elements --- */
    .debug-overlay {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 340px;
      max-width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.92);
      color: #0ff;
      z-index: 9999;
      font-size: 0.95em;
      font-family: monospace;
      overflow-y: auto;
      pointer-events: auto;
      border-left: 2px solid #0ff;
    }
    .debug-overlay-header {
      padding: 8px 12px;
      border-bottom: 1px solid #0ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .debug-close-btn {
      background: none;
      border: none;
      color: #0ff;
      font-size: 1.2em;
      cursor: pointer;
    }
    .debug-content {
      padding: 10px;
    }
    /* --- Add new class for custom hr and ul styles --- */
    .menu-hr {
      border: none;
      border-top: 1px solid #00ffff44;
      margin: 12px 0 8px 0;
    }
    .debug-list {
      margin: 0 0 8px 12px;
    }
    /* --- Add new class for menu header row layout --- */
    .menu-header-row {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
    }
    .menu-portrait-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 130px;
      min-width: 130px;
      margin-right: 0;
    }
    .menu-header-info {
      margin-left: 0;
      word-break: break-word;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 24px;
      align-items: start;
    }
    .menu-portrait-nav-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }
    .menu-portrait-nav-row .prev-party,
    .menu-portrait-nav-row .next-party {
      background: none;
      border: 1px solid #00ffff44;
      color: #00ffff;
      font-size: 1em;
      border-radius: 3px;
      padding: 0 6px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .menu-portrait-nav-row .prev-party:hover,
    .menu-portrait-nav-row .next-party:hover {
      background: #00ffff22;
      color: #fff;
    }
    .menu-party-name {
      font-weight: bold;
      color: #00ffff;
      font-size: 1.05em;
      margin: 0 2px;
    }
    .menu-class-label {
      margin-left: 10px;
      color: #00ffff;
      font-weight: bold;
      font-size: 1.05em;
    }
    .menu-class-value {
      color: #fff;
      font-weight: bold;
      margin-left: 2px;
      font-size: 1.05em;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game-canvas" width="640" height="480"></canvas>
    <div id="hud">Glittercloud Adventure</div>
    <div id="start-overlay">
      <div id="start-content">
        <div id="start-title">Glitter Cloud Adventure</div>
        <button id="start-btn">Start Game</button>
        <div id="start-credit">© Galaxander Corp. All Rights Reserved.</div>
      </div>
    </div>
    <!-- Cutscene Overlay -->
    <div id="cutscene-overlay">
      <div id="cutscene-bg"></div>
      <div id="cutscene-textbox">
        <div id="cutscene-text"></div>
        <div id="cutscene-skip">Press any key or click to skip</div>
      </div>
    </div>
    <div id="menu-overlay">
      <div id="menu-content">
        <div class="menu-header">
          <button class="menu-close-btn" id="menu-close-btn" title="Close">×</button>
        </div>
        <div class="menu-content-wrapper">
          <div class="menu-main-content">
            <!-- Character Tab: Rendered dynamically by MenuManager.renderTab('character'). Do not add static markup here. -->
            <div class="menu-tab-content" id="menu-tab-character"></div>
            <!-- Other tabs will be populated dynamically -->
            <div class="menu-tab-content" id="menu-tab-inventory" class="menu-tab-content hidden"></div>
            <div class="menu-tab-content" id="menu-tab-skills" class="menu-tab-content hidden"></div>
            <div class="menu-tab-content" id="menu-tab-equipment" class="menu-tab-content hidden"></div>
            <div class="menu-tab-content" id="menu-tab-relics" class="menu-tab-content hidden"></div>
            <div class="menu-tab-content" id="menu-tab-party" class="menu-tab-content hidden"></div>
            <div class="menu-tab-content" id="menu-tab-quests" class="menu-tab-content hidden"></div>
            <div class="menu-tab-content" id="menu-tab-settings" class="menu-tab-content hidden"></div>
          </div>
          <div class="menu-sidebar hidden">
            <div class="menu-detail">
              <button class="menu-detail-close" title="Close">×</button>
              <div class="menu-detail-title">Selected Item</div>
              <div class="menu-detail-content">
                Select an item to view details
              </div>
            </div>
          </div>
        </div>
        <div class="menu-tabs">
          <button class="menu-tab-btn active" data-tab="character">Char</button>
          <button class="menu-tab-btn" data-tab="inventory">Inv</button>
          <button class="menu-tab-btn" data-tab="skills">Skills</button>
          <button class="menu-tab-btn" data-tab="equipment">Equip</button>
          <button class="menu-tab-btn" data-tab="relics">Relics</button>
          <button class="menu-tab-btn" data-tab="quests">Quests</button>
          <button class="menu-tab-btn" data-tab="settings"><span style="font-size:1.2em;vertical-align:middle;">&#9881;</span></button>
        </div>
      </div>
    </div>
    <div id="debug-overlay" class="debug-overlay">
      <div class="debug-overlay-header">
        <span><b>Debug Overlay</b></span>
        <button id="debug-close-btn" class="debug-close-btn">×</button>
      </div>
      <div id="debug-content" class="debug-content"></div>
    </div>
  </div>
  <script>
    // SINGLE-FILE HTML RULE: All code is embedded here.
    // MODULARITY RULE: Use classes and clear structure.

    // --- Game Constants ---
    const TILE_SIZE = 32;
    const MAP_WIDTH = 20;
    const MAP_HEIGHT = 15;
    const GAME_WIDTH = TILE_SIZE * MAP_WIDTH;
    const GAME_HEIGHT = TILE_SIZE * MAP_HEIGHT;

    // --- Cutscene System ---
    class CutsceneManager {
      constructor(onFinish) {
        this.overlay = document.getElementById('cutscene-overlay');
        this.bgElem = document.getElementById('cutscene-bg');
        this.textElem = document.getElementById('cutscene-text');
        this.skipElem = document.getElementById('cutscene-skip');
        this.onFinish = onFinish;
        this.current = null;
        this.index = 0;
        this.timeout = null;
        this.skipped = false;
        this.typingTimeout = null;
        this.typewriterSpeed = 22; // ms per char
        this.handleSkip = this.handleSkip.bind(this);
      }
      play(cutscene) {
        this.current = cutscene;
        this.index = 0;
        this.skipped = false;
        this.overlay.style.display = 'block';
        this.textElem.textContent = '';
        this.bgElem.style.opacity = '1';
        document.getElementById('start-overlay').style.display = 'none';
        setTimeout(() => this.nextScene(), 100);
        window.addEventListener('keydown', this.handleSkip);
        window.addEventListener('mousedown', this.handleSkip);
        window.addEventListener('touchstart', this.handleSkip);
      }
      nextScene() {
        if (!this.current || this.index >= this.current.length || this.skipped) {
          this.end();
          return;
        }
        const scene = this.current[this.index];
        if (scene.background) {
          this.bgElem.style.backgroundImage = `url('${scene.background}')`;
        } else {
          this.bgElem.style.backgroundImage = '';
        }
        this.textElem.textContent = '';
        this.textElem.className = '';
        if (scene.text.includes('Galaxander')) {
          this.textElem.classList.add('galaxander');
        }
        this._typeText(scene.text, 0, () => {
          this.timeout = setTimeout(() => {
            this.index++;
            this.nextScene();
          }, scene.duration);
        });
      }
      _typeText(text, i, done) {
        if (this.skipped) return;
        if (i <= text.length) {
          this.textElem.textContent = text.slice(0, i);
          this.typingTimeout = setTimeout(() => this._typeText(text, i + 1, done), this.typewriterSpeed);
        } else {
          done();
        }
      }
      handleSkip() {
        this.skipped = true;
        this.end();
      }
      end() {
        clearTimeout(this.timeout);
        clearTimeout(this.typingTimeout);
        this.overlay.style.display = 'none';
        this.textElem.textContent = '';
        this.bgElem.style.backgroundImage = '';
        window.removeEventListener('keydown', this.handleSkip);
        window.removeEventListener('mousedown', this.handleSkip);
        window.removeEventListener('touchstart', this.handleSkip);
        document.getElementById('start-overlay').style.display = 'flex';
        if (this.onFinish) this.onFinish();
      }
    }

    // Update the introCutscene array to include all scenes from the original introscene in gcaworking.html
    const introCutscene = [
      {
        text: "We had no idea Earth was for sale.\nUntil we were purchased by the interstellar version of P.T. Barnum",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/Narrative1-q2mDBsKvyqQsNn7Zu7a3QT36p2M9hh.png?vGuq",
        duration: 2000
      },
      {
        text: "It was just a normal day on Earth. People were grocery shopping. Picking up their kids. Scrolling. Swiping. Swearing at traffic.",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/Shopping-58EG1CsWpUH7RBPY3jXTyyxBdLrCm1.png?SMlF",
        duration: 2000
      },
      {
        text: "A piercing PING! erupts from every screen—phones, billboards, smart‑watches—halting seven billion heartbeats in unison.",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/Shock-FE8GYBHDyJ1NXFS6vDl4O6K36GIVA1.png?pZxF",
        duration: 2000
      },
      {
        text: "The message repeats in every language as panic sparks.",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/Auction-DD4H0eTvXmUDImg5FIuH8a8bPot7Xq.png?0KdN",
        duration: 2000
      },
      {
        text: "Shafts of electric light skewer the streets; citizens are digitized mid‑stride and whisked skyward in shimmering data‑streams.",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/TeleportStore-o52yEto3qZbwQuZkZmi2RlKjTaXsaE.png?wblu",
        duration: 2000
      },
      {
        text: "In transit, bodies recompile—jeans into neon jumpsuits, flesh into pixel‑sheened avatars—stats and health bars flickering overhead.",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/Transformation-BzVmMb5tmkizSnIxX5rDDqv5YnvKF7.png?mppc",
        duration: 2000
      },
      {
        text: "Humanity rematerializes inside a boundless, zero‑G arcade. Cabinets ignite, revealing the grinning visage of Galaxander: 'Welcome, contestants! Your planet has been acquired by the Galaxander Corporation and all of you now star in the ultimate intergalactic game show.'",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/ArcadeWelcomeAnime-HTgSCgK8bb5l026TEsrtvxLs2WoovU.png?ixZi",
        duration: 2500
      },
      {
        text: "Alarms blare. Prize hatches on every claw machine burst open, spewing goblins that swarm the floor—Level One has begun.",
        background: "https://lqy3lriiybxcejon.public.blob.vercel-storage.com/c3AEorTjqZQC/Firrstfight-k99DrfTi1srSIFLGPo0tqI0oX2neX3.png?32eu",
        duration: 2000
      }
    ];

    // --- Map System ---
    class GameMap {
      constructor() {
        // 0 = floor, 1 = wall
        this.grid = Array.from({length: MAP_HEIGHT}, (_, y) =>
          Array.from({length: MAP_WIDTH}, (_, x) =>
            (x === 0 || y === 0 || x === MAP_WIDTH-1 || y === MAP_HEIGHT-1) ? 1 : 0
          )
        );
        // Add some interior walls
        this.grid[5][5] = 1; this.grid[5][6] = 1;
        this.grid[6][5] = 1; this.grid[6][6] = 1;
        this.grid[8][10] = 1; this.grid[9][10] = 1;
      }
      isWall(x, y) {
        return this.grid[y] && this.grid[y][x] === 1;
      }
      render(ctx) {
        for (let y = 0; y < MAP_HEIGHT; y++) {
          for (let x = 0; x < MAP_WIDTH; x++) {
            if (this.grid[y][x] === 1) {
              ctx.fillStyle = '#444';
              ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else {
              ctx.fillStyle = '#222';
              ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            ctx.strokeStyle = '#333';
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
          }
        }
      }
    }

    // --- Class Data (from gcaworking.html) ---
    const CLASSES = {
      ASPIRING: {
        name: "Aspiring",
        vitToHpMult: 5,
        intToMpMult: 3,
        strToAtkMult: 1,
        vitToDefMult: 0.5,
        dexToSpdMult: 1,
        baseGrowth: {
          strength: 1,
          vitality: 1,
          dexterity: 1,
          intelligence: 1,
          luck: 1,
          charisma: 1,
          fortune: 1
        },
        skillProgression: {}
      },
      FLEXECUTIONER: {
        name: "Flexecutioner",
        vitToHpMult: 7,
        intToMpMult: 2,
        strToAtkMult: 1.2,
        vitToDefMult: 0.7,
        dexToSpdMult: 0.7,
        baseGrowth: {
          strength: 1.2,
          vitality: 1.0,
          dexterity: 0.7,
          intelligence: 0.4,
          luck: 0.5,
          charisma: 0.6,
          fortune: 0.5
        },
        skillProgression: {
          1: [{ name: "Power Strike", type: "active", mpCost: 5, cooldown: 3, description: "220% STR damage. 20% chance to Bleed (10% HP over 3 turns)." }],
          3: [{ name: "Protein Shake", type: "passive", mpCost: 0, cooldown: 0, description: "+4% max HP & +5% HP regen in overworld" }],
          5: [{ name: "Swole Stomp", type: "active", mpCost: 10, cooldown: 5, description: "Powerful AoE with stun chance." }]
        }
      },
      RIZZLER: {
        name: "Rizzler",
        vitToHpMult: 4,
        intToMpMult: 5,
        strToAtkMult: 0.4,
        vitToDefMult: 0.6,
        dexToSpdMult: 0.8,
        baseGrowth: {
          strength: 0.4,
          vitality: 0.6,
          dexterity: 0.8,
          intelligence: 1.0,
          luck: 0.7,
          charisma: 1.2,
          fortune: 0.7
        },
        skillProgression: {
          1: [{ name: "Charm", type: "active", mpCost: 4, cooldown: 2, description: "Chance to confuse enemy." }],
          3: [{ name: "Viral Post", type: "active", mpCost: 8, cooldown: 4, description: "AoE debuff, lowers enemy defense." }],
          5: [{ name: "Trendsetter", type: "passive", mpCost: 0, cooldown: 0, description: "Party-wide buff to speed." }]
        }
      },
      "SUS-ASSASSIN": {
        name: "Sus-Assassin",
        vitToHpMult: 5,
        intToMpMult: 3,
        strToAtkMult: 0.8,
        vitToDefMult: 0.7,
        dexToSpdMult: 1.2,
        baseGrowth: {
          strength: 0.8,
          vitality: 0.7,
          dexterity: 1.2,
          intelligence: 0.5,
          luck: 1.0,
          charisma: 0.8,
          fortune: 1.0
        },
        skillProgression: {
          1: [{ name: "Backstab", type: "active", mpCost: 6, cooldown: 3, description: "High crit chance attack." }],
          3: [{ name: "Shadowmeld", type: "active", mpCost: 8, cooldown: 5, description: "Become untargetable for 1 turn." }],
          5: [{ name: "Perfect Precision", type: "passive", mpCost: 0, cooldown: 0, description: "5% chance for attacks to ignore defense." }]
        }
      },
      INFLUMANCER: {
        name: "Influmancer",
        vitToHpMult: 3,
        intToMpMult: 7,
        strToAtkMult: 0.3,
        vitToDefMult: 0.5,
        dexToSpdMult: 0.7,
        baseGrowth: {
          strength: 0.3,
          vitality: 0.5,
          dexterity: 0.7,
          intelligence: 1.2,
          luck: 0.9,
          charisma: 1.0,
          fortune: 0.9
        },
        skillProgression: {
          1: [{ name: "Hype Wave", type: "active", mpCost: 7, cooldown: 3, description: "Party-wide heal." }],
          3: [{ name: "Trending", type: "passive", mpCost: 0, cooldown: 0, description: "Status effects last 2 turns longer." }],
          5: [{ name: "Reality Administrator", type: "passive", mpCost: 0, cooldown: 0, description: "15% chance for spells to cost 0 MP." }]
        }
      }
    };

    // --- Skill Structure ---
    // { name, type, mpCost, cooldown, description, unlocked (bool), levelUnlocked }

    // --- Character System ---
    class Character {
      constructor(options = {}) {
        // Core identity
        this.id = options.id || `char_${Date.now()}_${Math.floor(Math.random()*10000)}`;
        this.name = options.name || "Player";
        this.class = options.class || "ASPIRING";
        this.level = options.level || 1;
        this.experience = options.experience || 0;
        this.experienceToNextLevel = options.experienceToNextLevel || 100;
        this.prestigeLevel = options.prestigeLevel || 0;
        this.prestigeTalent = options.prestigeTalent || null;
        this.prestigeAura = options.prestigeAura || null;
        this.createdAt = options.createdAt || Date.now();
        this.lastPlayed = options.lastPlayed || Date.now();

        // Stats & attributes
        this.stats = Object.assign({
          strength: 10,
          dexterity: 10,
          vitality: 10,
          intelligence: 10,
          luck: 10,
          charisma: 10,
          fortune: 10
        }, options.stats);
        this.baseStats = Object.assign({}, this.stats);
        this.derivedStats = options.derivedStats || {};
        this.statPoints = options.statPoints || 0;
        this.skillPoints = options.skillPoints || 0;
        this.hp = options.hp || 100;
        this.maxHp = options.maxHp || 100;
        this.mp = options.mp || 30;
        this.maxMp = options.maxMp || 30;
        this.gold = options.gold || 0;

        // Progression
        this.pendingClassSelection = options.pendingClassSelection || false;
        this.availablePoints = options.availablePoints || 0;
        this.statsLocked = options.statsLocked || false;

        // Skills & abilities
        this.skills = options.skills || [];
        this.spells = options.spells || [];
        this.passives = options.passives || [];
        this.masteredSkills = options.masteredSkills || [];
        this.pendingSkillNotifications = options.pendingSkillNotifications || [];

        // Equipment & inventory
        this.equipment = Object.assign({
          MAIN_HAND: null,
          OFF_HAND: null,
          HEAD: null,
          BODY: null,
          LEGS: null,
          FEET: null,
          RELIC_1: null,
          RELIC_2: null
        }, options.equipment);
        this.inventory = options.inventory || [];

        // Party & relationships
        this.relationships = options.relationships || {};
        this.partyOrder = options.partyOrder || 0;
        this.partyActive = options.partyActive !== undefined ? options.partyActive : true;

        // Status & effects
        this.statusEffects = options.statusEffects || [];
        this.effects = options.effects || [];

        // Cosmic powers
        this.cosmicPowers = options.cosmicPowers || [];
        this.cosmicBalance = options.cosmicBalance || { harmony: 0, chaos: 0, stability: 0 };
        this.cosmicCombos = options.cosmicCombos || [];

        // Type mastery & achievements
        this.typeMastery = options.typeMastery || {};
        this.achievements = options.achievements || [];

        // Quests & story
        this.quests = options.quests || { active: [], completed: [] };
        this.questStates = options.questStates || {};
        this.storylinePosition = options.storylinePosition || { chapter: 1, scene: 1, flags: {} };

        // Relics
        this.relics = options.relics || {};
        this.fury = options.fury || 0;
        this.masteredRelicSkills = options.masteredRelicSkills || [];

        // Animation state
        this.sprite = options.sprite || null;
        this.direction = options.direction || "down";
        this.frame = options.frame || 0;
        this.animationState = options.animationState || { isIdle: true };

        this.calculateDerivedStats();
        this.initSkills();
      }
      initSkills() {
        // Unlock skills for current level
        const classData = CLASSES[this.class] || CLASSES.ASPIRING;
        this.skills = [];
        for (const lvl in classData.skillProgression) {
          if (this.level >= parseInt(lvl)) {
            for (const skill of classData.skillProgression[lvl]) {
              this.skills.push({ ...skill, unlocked: true, levelUnlocked: parseInt(lvl) });
            }
          }
        }
      }
      calculateDerivedStats() {
        const classData = CLASSES[this.class] || CLASSES.ASPIRING;
        this.derivedStats = {
          maxHp: Math.floor(10 + (this.stats.vitality * (classData.vitToHpMult || 5)) + (this.level * 2)),
          maxMp: Math.floor(5 + (this.stats.intelligence * (classData.intToMpMult || 3)) + this.level),
          attack: Math.floor(this.stats.strength * (classData.strToAtkMult || 1)),
          defense: Math.floor(this.stats.vitality * (classData.vitToDefMult || 0.5)),
          speed: Math.floor(this.stats.dexterity * (classData.dexToSpdMult || 1)),
          critChance: Math.min(5 + Math.floor(this.stats.fortune / 4), 30),
          evasion: Math.min(Math.floor(this.stats.dexterity / 2), 25)
        };
        this.maxHp = this.derivedStats.maxHp;
        this.maxMp = this.derivedStats.maxMp;
        // If new character, always sync hp/mp to max
        if (this.level === 1 && this.experience === 0) {
          this.hp = this.maxHp;
          this.mp = this.maxMp;
        } else {
          if (!this.hp || this.hp > this.maxHp) this.hp = this.maxHp;
          if (!this.mp || this.mp > this.maxMp) this.mp = this.maxMp;
        }
      }
      gainExperience(amount) {
        this.experience += amount;
        while (this.experience >= this.experienceToNextLevel) {
          this.experience -= this.experienceToNextLevel;
          this.levelUp();
        }
      }
      levelUp() {
        this.level += 1;
        // Class-based stat growth
        const classData = CLASSES[this.class] || CLASSES.ASPIRING;
        for (const stat in classData.baseGrowth) {
          if (this.stats[stat] !== undefined) {
            this.stats[stat] += classData.baseGrowth[stat];
          }
        }
        this.experienceToNextLevel = Math.floor(100 * Math.pow(1.5, this.level - 1));
        this.calculateDerivedStats();
        // Unlock new skills if available
        this.initSkills();
        // Class advancement at level 5
        if (this.level === 5 && this.class === "ASPIRING") {
          this.pendingClassSelection = true;
        }
        // Prestige at level 80 (example)
        if (this.level === 80) {
          this.prestige();
        }
      }
      prestige() {
        // Prestige: reset to level 1, retain skills/mastery, stat retention, assign talent
        this.prestigeLevel = (this.prestigeLevel || 0) + 1;
        // Retain 10% of stats
        for (const stat in this.stats) {
          this.stats[stat] = Math.floor(this.stats[stat] * 0.1);
        }
        this.level = 1;
        this.experience = 0;
        this.experienceToNextLevel = 100;
        this.prestigeAura = true;
        // Retain all mastered skills
        this.masteredSkills = [...this.skills];
        // Assign prestige talent based on class
        const talents = {
          FLEXECUTIONER: "Limitless Gains",
          RIZZLER: "Endless Charisma",
          "SUS-ASSASSIN": "Perfect Precision",
          INFLUMANCER: "Reality Administrator"
        };
        this.prestigeTalent = talents[this.class] || null;
        this.calculateDerivedStats();
      }
    }

    // --- Player Entity ---
    class Player {
      constructor(x, y, map) {
        // Use Character for all player data
        this.character = new Character({
          name: "Hazel",
          class: "ASPIRING",
          level: 1,
          experience: 0,
          stats: {
            strength: 10,
            dexterity: 10,
            vitality: 10,
            intelligence: 10,
            luck: 10,
            charisma: 10,
            fortune: 10
          },
          hp: 100,
          maxHp: 100,
          mp: 30,
          maxMp: 30,
          gold: 0,
          sprite: null,
          direction: "down",
          frame: 0
        });
        this.x = x;
        this.y = y;
        this.size = TILE_SIZE;
        this.color = '#0ff';
        this.speed = 200;
        this.keys = {};
        this.map = map;
      }
      handleKey(key, isDown) {
        this.keys[key.toLowerCase()] = isDown;
      }
      update(dt) {
        let dx = 0, dy = 0;
        if (this.keys['arrowup'] || this.keys['w']) dy -= 1;
        if (this.keys['arrowdown'] || this.keys['s']) dy += 1;
        if (this.keys['arrowleft'] || this.keys['a']) dx -= 1;
        if (this.keys['arrowright'] || this.keys['d']) dx += 1;
        if (dx !== 0 && dy !== 0) { dx *= Math.SQRT1_2; dy *= Math.SQRT1_2; }
        let newX = this.x + dx * this.speed * dt;
        let newY = this.y + dy * this.speed * dt;
        // Collision detection
        if (!this.collides(newX, this.y)) this.x = newX;
        if (!this.collides(this.x, newY)) this.y = newY;
        // Clamp to map
        this.x = Math.max(0, Math.min(GAME_WIDTH - this.size, this.x));
        this.y = Math.max(0, Math.min(GAME_HEIGHT - this.size, this.y));
      }
      collides(x, y) {
        // Check all four corners
        const corners = [
          [x, y],
          [x + this.size - 1, y],
          [x, y + this.size - 1],
          [x + this.size - 1, y + this.size - 1]
        ];
        for (const [cx, cy] of corners) {
          const tx = Math.floor(cx / TILE_SIZE);
          const ty = Math.floor(cy / TILE_SIZE);
          if (this.map.isWall(tx, ty)) return true;
        }
        return false;
      }
      render(ctx) {
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.size, this.size);
      }
    }

    // --- HUD ---
    function updateHUD(player) {
      let hud = document.getElementById('hud');
      if (!hud) return;
      const c = player.character;
      hud.innerHTML = `
        <b>${c.name}</b> (Lv.${c.level}${c.prestigeLevel > 0 ? '★'.repeat(c.prestigeLevel) : ''})<br>
        HP: ${c.hp} / ${c.maxHp} &nbsp; MP: ${c.mp} / ${c.maxMp}<br>
        STR: ${c.stats.strength} &nbsp; DEX: ${c.stats.dexterity} &nbsp; VIT: ${c.stats.vitality} &nbsp; INT: ${c.stats.intelligence}<br>
        ATK: ${c.derivedStats.attack} &nbsp; DEF: ${c.derivedStats.defense} &nbsp; SPD: ${c.derivedStats.speed}<br>
        CRIT: ${c.derivedStats.critChance}% &nbsp; EVA: ${c.derivedStats.evasion}%<br>
        Gold: ${c.gold}
      `;
    }

    // --- Game Engine ---
    class Game {
      constructor() {
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.lastTime = 0;
        this.map = new GameMap();
        this.player = new Player(2 * TILE_SIZE, 2 * TILE_SIZE, this.map);
        this.bindEvents();
        requestAnimationFrame(this.loop.bind(this));
      }
      bindEvents() {
        window.addEventListener('keydown', e => this.player.handleKey(e.key, true));
        window.addEventListener('keyup', e => this.player.handleKey(e.key, false));
      }
      loop(ts) {
        const dt = (ts - this.lastTime) / 1000;
        this.lastTime = ts;
        this.update(dt);
        this.render();
        updateHUD(this.player);
        requestAnimationFrame(this.loop.bind(this));
      }
      update(dt) {
        this.player.update(dt);
      }
      render() {
        this.ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        this.map.render(this.ctx);
        this.player.render(this.ctx);
      }
    }

    // --- Start Game ---
    function setupMenuManager() {
      if (!window.menuManager && window.game && window.game.player && window.game.player.character) {
        window.menuManager = new MenuManager();
        // Set up party members (for now, just the player character)
        const hazelFrames = [
          'https://lqy3lriiybxcejon.public.blob.vercel-storage.com/02734c7f-ee83-4cb8-a785-4c5b9b9e62fc/Jump_1-EHd6aTym2GZYG9YGUObU4C3UVzRM4J.png?yK6e',
          'https://lqy3lriiybxcejon.public.blob.vercel-storage.com/02734c7f-ee83-4cb8-a785-4c5b9b9e62fc/Jump_1-EHd6aTym2GZYG9YGUObU4C3UVzRM4J.png?yK6e',
          'https://lqy3lriiybxcejon.public.blob.vercel-storage.com/02734c7f-ee83-4cb8-a785-4c5b9b9e62fc/Jump_3-CHy1ZtpTESzTZIRzKqWCAn8f1YeO3w.png?uMN1',
          'https://lqy3lriiybxcejon.public.blob.vercel-storage.com/02734c7f-ee83-4cb8-a785-4c5b9b9e62fc/Jump_4-gSm4PyttYHunekRzEFgIHAKnZQDwfA.png?9b67',
          'https://lqy3lriiybxcejon.public.blob.vercel-storage.com/02734c7f-ee83-4cb8-a785-4c5b9b9e62fc/Jump_5-FZ0aZQXgDbESB4PHVg49uHFLt0LmT0.png?7Y1S'
        ];
        window.menuManager.partyMembers = [window.game.player.character];
        window.menuManager.partyMembers.forEach(member => {
          if (member.name === 'Hazel') {
            member.portraitFrames = hazelFrames;
          } else if (!Array.isArray(member.portraitFrames)) {
            member.portraitFrames = hazelFrames;
          }
        });
        window.menuManager.partyIndex = 0;
        window.menuManager.updatePartyNav();
      }
    }
    function startGame() {
      window.debugLog && window.debugLog('startGame() called');
      document.getElementById('start-overlay').classList.add('hidden');
      setTimeout(() => {
        document.getElementById('start-overlay').style.display = 'none';
        window.game = new Game();
        window.gameReady = true;
        setupMenuManager();
        window.debugLog && window.debugLog('Game started: window.game is set. MenuManager initialized.');
      }, 350);
    }
    window.addEventListener('load', () => {
      const startBtn = document.getElementById('start-btn');
      if (startBtn) {
        startBtn.onclick = startGame;
        window.debugLog && window.debugLog('startBtn.onclick set');
      }
      // Start with cutscene
      const cutscene = new CutsceneManager(() => {});
      cutscene.play(introCutscene);
    });

    // --- MenuManager ---
    class MenuManager {
      constructor() {
        this.overlay = document.getElementById('menu-overlay');
        this.tabs = Array.from(document.querySelectorAll('.menu-tab-btn'));
        this.tabContents = {
          character: document.getElementById('menu-tab-character'),
          inventory: document.getElementById('menu-tab-inventory'),
          skills: document.getElementById('menu-tab-skills'),
          equipment: document.getElementById('menu-tab-equipment'),
          relics: document.getElementById('menu-tab-relics'),
          party: document.getElementById('menu-tab-party'),
          quests: document.getElementById('menu-tab-quests'),
          settings: document.getElementById('menu-tab-settings')
        };
        this.closeBtn = document.getElementById('menu-close-btn');
        this.activeTab = 'character';
        this.selectedItem = null;
        this.partyIndex = 0;
        this.partyMembers = [];
        this.sidebar = document.querySelector('.menu-sidebar');
        this.sidebarCloseBtn = this.sidebar.querySelector('.menu-detail-close');
        this.sidebarCloseBtn.onclick = () => this.clearSelection();
        this._bindEvents();
        this._setupPortraitAnimation();
      }

      _bindEvents() {
        this.closeBtn.onclick = () => this.close();
        this.tabs.forEach(tab => {
          tab.onclick = () => this.switchTab(tab.dataset.tab);
        });
        // Remove static party nav button bindings here
        // Global keyboard shortcuts
        window.addEventListener('keydown', e => {
          if (e.key === 'Escape') this.close();
          if (e.key === 'ArrowLeft') this.cycleParty(-1);
          if (e.key === 'ArrowRight') this.cycleParty(1);
          // Menu toggle with 'M' key
          if (e.key.toLowerCase() === 'm' && document.activeElement.tagName !== 'INPUT') {
            if (this.overlay.classList.contains('open')) {
              this.close();
            } else {
              this.open();
            }
          }
        });
      }

      _setupPortraitAnimation() {
        let portraitFrameIdx = 0;
        let portraitInterval = null;
        let forward = true;

        const updatePortrait = (forceFirstFrame = false) => {
          const char = this.getCurrentChar();
          const img = document.getElementById('menu-portrait-img');
          if (!img) { console.log('[Portrait] <img> not found'); return; }
          if (!char || !char.name) {
            img.src = '';
            img.alt = 'Portrait';
            console.warn('[Portrait] No character selected for portrait animation.');
            return;
          }
          let frames = Array.isArray(char.portraitFrames) ? char.portraitFrames : [];
          if (frames.length > 0) {
            if (forceFirstFrame) portraitFrameIdx = 0;
            img.src = frames[portraitFrameIdx % frames.length];
            img.alt = char.name + ' Portrait';
          } else {
            img.src = 'https://lqy3lriiybxcejon.public.blob.vercel-storage.com/02734c7f-ee83-4cb8-a785-4c5b9b9e62fc/Jump_1-EHd6aTym2GZYG9YGUObU4C3UVzRM4J.png?yK6e';
            img.alt = char.name || 'Portrait';
          }
        };

        const startPortraitAnimation = () => {
          if (portraitInterval) clearInterval(portraitInterval);
          portraitFrameIdx = 0;
          forward = true;
          const char = this.getCurrentChar();
          if (!char || !char.name) return;
          let frames = Array.isArray(char.portraitFrames) ? char.portraitFrames : [];
          updatePortrait(true);
          if (frames.length > 1) {
            portraitInterval = setInterval(() => {
              if (forward) {
                portraitFrameIdx++;
                if (portraitFrameIdx >= frames.length - 1) {
                  forward = false;
                }
              } else {
                portraitFrameIdx--;
                if (portraitFrameIdx <= 0) {
                  forward = true;
                }
              }
              updatePortrait();
            }, 180);
          }
        };

        this.updatePortrait = updatePortrait;
        this.startPortraitAnimation = startPortraitAnimation;
      }

      getCurrentChar() {
        return this.partyMembers[this.partyIndex] || {};
      }

      open() {
        this.overlay.classList.add('open');
        this.switchTab(this.activeTab);
        this.updatePartyNav();
      }

      close() {
        this.overlay.classList.remove('open');
        this.clearSelection();
      }

      switchTab(tab) {
        this.activeTab = tab;
        this.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
        Object.keys(this.tabContents).forEach(key => {
          this.tabContents[key].style.display = (key === tab) ? '' : 'none';
        });
        // Always clear selection and hide sidebar on tab switch
        this.clearSelection();
        this.renderTab(tab);
      }

      cycleParty(direction) {
        if (!this.partyMembers.length) return;
        this.partyIndex = (this.partyIndex + direction + this.partyMembers.length) % this.partyMembers.length;
        this.updatePartyNav();
        this.renderTab(this.activeTab);
      }

      updatePartyNav() {
        const nameEl = document.querySelector('.menu-party-name');
        if (nameEl) nameEl.textContent = this.getCurrentChar().name || 'None';
        this.startPortraitAnimation();
      }

      selectItem(item) {
        this.selectedItem = item;
        const detailContent = document.querySelector('.menu-detail-content');
        if (!detailContent) return;
        if (!item) {
          this.sidebar.style.display = 'none';
          detailContent.innerHTML = 'Select an item to view details';
          return;
        }
        this.sidebar.style.display = '';
        detailContent.innerHTML = `
          <h3>${item.name}</h3>
          ${item.description ? `<p>${item.description}</p>` : ''}
          ${item.stats ? `
            <div class="menu-stats-grid">
              ${Object.entries(item.stats).map(([key, value]) => `
                <div class="menu-stat">
                  <span class="menu-stat-label">${key}</span>
                  <span class="menu-stat-value">${value}</span>
                </div>
              `).join('')}
            </div>
          ` : ''}
        `;
      }

      clearSelection() {
        this.selectedItem = null;
        this.sidebar.style.display = 'none';
      }

      renderTab(tab) {
        const player = window.game?.player?.character;
        if (!player) return;
        // Hide sidebar by default
        this.sidebar.style.display = 'none';
        switch(tab) {
          case 'character':
            this.tabContents.character.innerHTML = `
              <div class="menu-card">
                <div class="menu-header-row">
                  <div class="menu-portrait-block">
                    <img id="menu-portrait-img" class="menu-portrait" src="${player.portraitFrames && player.portraitFrames[0] ? player.portraitFrames[0] : ''}" alt="Portrait" />
                    <div class="menu-portrait-nav-row">
                      <button class="prev-party">◄</button>
                      <span class="menu-party-name">${player.name}</span>
                      <button class="next-party">►</button>
                      <span class="menu-class-label">Class:<span class="menu-class-value">${player.class}</span></span>
                    </div>
                  </div>
                  <div class="menu-header-info">
                    <div><span class="menu-stat-label">Level:</span><span class="menu-stat-value">${player.level}</span></div>
                    <div><span class="menu-stat-label">HP:</span><span class="menu-stat-value">${player.hp}/${player.maxHp}</span></div>
                    <div><span class="menu-stat-label">MP:</span><span class="menu-stat-value">${player.mp}/${player.maxMp}</span></div>
                    <div><span class="menu-stat-label">XP:</span><span class="menu-stat-value">${player.experience}/${player.experienceToNextLevel}</span></div>
                    <div><span class="menu-stat-label">Gold:</span><span class="menu-stat-value gold-value">${player.gold}</span></div>
                  </div>
                </div>
                <hr class="menu-hr" />
                <div class="stat-grid">
                  ${['strength','intelligence','vitality','dexterity','fortune','charisma'].map(stat => `
                    <div class="stat-box">
                      <span class="stat-label">${stat.charAt(0).toUpperCase() + stat.slice(1)}</span>
                      <span class="stat-controls">
                        <button class="stat-button" onclick="window.menuManager.allocateStat('${stat}',-1)" ${player.statPoints <= 0 || player.stats[stat] <= player.baseStats[stat] ? 'disabled' : ''}>-</button>
                        <span class="stat-value">${player.stats[stat]}</span>
                        <button class="stat-button" onclick="window.menuManager.allocateStat('${stat}',1)" ${player.statPoints <= 0 ? 'disabled' : ''}>+</button>
                      </span>
                    </div>
                  `).join('')}
                </div>
                <div class="derived-stats-grid">
                  <div><span>ATK:</span> <b>${player.derivedStats.attack}</b></div>
                  <div><span>DEF:</span> <b>${player.derivedStats.defense}</b></div>
                  <div><span>SPD:</span> <b>${player.derivedStats.speed}</b></div>
                  <div><span>CRIT:</span> <b>${player.derivedStats.critChance}%</b></div>
                  <div><span>EVA:</span> <b>${player.derivedStats.evasion}%</b></div>
                </div>
                <div class="stat-points-row">
                  <span class="stat-points-label">Stat Points:</span>
                  <span class="stat-points-value">${player.statPoints}</span>
                  <button class="stat-confirm-btn" onclick="window.menuManager.confirmStatAllocation()" ${player.statPoints === 0 ? 'disabled' : ''}>Confirm</button>
                </div>
              </div>
            `;
            // Bind party nav buttons after dynamic HTML is injected
            const prevBtn = this.tabContents.character.querySelector('.prev-party');
            const nextBtn = this.tabContents.character.querySelector('.next-party');
            if (prevBtn) prevBtn.onclick = () => this.cycleParty(-1);
            if (nextBtn) nextBtn.onclick = () => this.cycleParty(1);
            break;

          case 'inventory':
            this.tabContents.inventory.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Inventory</div>
                <div class="menu-list">
                  ${player.inventory.length > 0 
                    ? player.inventory.map((item, idx) => `
                        <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].inventory[${idx}])">
                          <span>${item.name}</span>
                          <span>${item.quantity || 1}</span>
                        </div>
                      `).join('')
                    : '<div class="menu-list-item">No items in inventory</div>'
                  }
                </div>
              </div>
            `;
            break;

          case 'skills':
            this.tabContents.skills.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Active Skills</div>
                <div class="menu-list">
                  ${player.skills.filter(s => s.type === 'active').map((skill, idx) => `
                    <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].skills.filter(s=>s.type==='active')[${idx}])">
                      <span>${skill.name}</span>
                      <span>MP: ${skill.mpCost}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
              <div class="menu-card">
                <div class="menu-card-title">Passive Skills</div>
                <div class="menu-list">
                  ${player.skills.filter(s => s.type === 'passive').map((skill, idx) => `
                    <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].skills.filter(s=>s.type==='passive')[${idx}])">
                      <span>${skill.name}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;

          case 'equipment':
            this.tabContents.equipment.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Equipment</div>
                <div class="menu-list">
                  ${Object.entries(player.equipment).map(([slot, item], idx) => `
                    <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].equipment['${slot}'])">
                      <span>${slot.replace('_', ' ')}</span>
                      <span>${item ? item.name : 'Empty'}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;

          case 'relics':
            this.tabContents.relics.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Relics</div>
                <div class="menu-list">
                  ${Object.values(player.relics).length > 0
                    ? Object.values(player.relics).map((relic, idx) => `
                        <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].relics[Object.keys(window.menuManager.partyMembers[window.menuManager.partyIndex].relics)[${idx}]])">
                          <span>${relic.name} ${player.equipment.RELIC_1 === relic || player.equipment.RELIC_2 === relic ? '(Equipped)' : ''}</span>
                          <span>Lv.${relic.level}</span>
                        </div>
                      `).join('')
                    : '<div class="menu-list-item">No relics owned</div>'
                  }
                </div>
              </div>
            `;
            break;

          case 'party':
            this.tabContents.party.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Party Members</div>
                <div class="menu-list">
                  <div class="menu-list-item">
                    <span>${player.name}</span>
                    <span>Lv.${player.level} ${player.class}</span>
                  </div>
                  ${Object.entries(player.relationships).map(([name, rel]) => `
                    <div class="menu-list-item">
                      <span>${name}</span>
                      <span>${rel.level}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
            break;

          case 'quests':
            this.tabContents.quests.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Active Quests</div>
                <div class="menu-list">
                  ${player.quests.active.length > 0 
                    ? player.quests.active.map((quest, idx) => `
                        <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].quests.active[${idx}])">
                          <span>${quest.name}</span>
                          <span>${quest.progress || 0}%</span>
                        </div>
                      `).join('')
                    : '<div class="menu-list-item">No active quests</div>'
                  }
                </div>
              </div>
              <div class="menu-card">
                <div class="menu-card-title">Completed Quests</div>
                <div class="menu-list">
                  ${player.quests.completed.length > 0 
                    ? player.quests.completed.map((quest, idx) => `
                        <div class="menu-list-item" onclick="window.menuManager.selectItem(window.menuManager.partyMembers[window.menuManager.partyIndex].quests.completed[${idx}])">
                          <span>${quest.name}</span>
                          <span>${new Date(quest.completedAt).toLocaleDateString()}</span>
                        </div>
                      `).join('')
                    : '<div class="menu-list-item">No completed quests</div>'
                  }
                </div>
              </div>
            `;
            break;

          case 'settings':
            this.tabContents.settings.innerHTML = `
              <div class="menu-card">
                <div class="menu-card-title">Game Settings</div>
                <div class="menu-list">
                  <div class="menu-list-item">
                    <span>Audio</span>
                    <span>[Sliders]</span>
                  </div>
                  <div class="menu-list-item">
                    <span>Display</span>
                    <span>[Toggles]</span>
                  </div>
                  <div class="menu-list-item">
                    <span>Controls</span>
                    <span>[View]</span>
                  </div>
                </div>
              </div>
            `;
            break;
        }
      }
      allocateStat(stat, amount) {
        const player = window.game?.player?.character;
        if (!player) return;
        if (amount > 0 && player.statPoints > 0) {
          player.stats[stat] += 1;
          player.statPoints -= 1;
        } else if (amount < 0 && player.stats[stat] > player.baseStats[stat]) {
          player.stats[stat] -= 1;
          player.statPoints += 1;
        }
        player.calculateDerivedStats();
        this.renderTab('character');
      }
      confirmStatAllocation() {
        // In this simple version, just lock in the stats (could add more logic if needed)
        this.renderTab('character');
      }
    }

    // --- DebugManager ---
    class DebugManager {
      constructor() {
        this.overlay = document.getElementById('debug-overlay');
        this.content = document.getElementById('debug-content');
        this.closeBtn = document.getElementById('debug-close-btn');
        this.visible = false;
        this._bindEvents();
      }

      _bindEvents() {
        this.closeBtn.onclick = () => {
          this.overlay.style.display = 'none';
          this.visible = false;
        };

        window.addEventListener('keydown', e => {
          if (e.key === '`' || e.key === '~') {
            this.visible = !this.visible;
            this.overlay.style.display = this.visible ? 'block' : 'none';
            this.update(e.key);
          }
        });
      }

      log(msg) {
        if (!this.content) return;
        const p = document.createElement('div');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        this.content.appendChild(p);
        this.content.scrollTop = this.content.scrollHeight;
      }

      update(lastKey) {
        const menuOpen = document.getElementById('menu-overlay').classList.contains('open');
        const player = window.game?.player?.character;
        this.content.innerHTML = `
          <b>Menu Open:</b> ${menuOpen}<br>
          <b>Last Key:</b> ${lastKey || ''}<br>
          <b>Relics:</b><br>
          <ul class="debug-list">
            ${player ? Object.values(player.relics).map(r => `<li>${r.name} (id: ${r.id}, lvl: ${r.level}, xp: ${r.xp}/${r.xpToNextLevel})</li>`).join('') : '<li>None</li>'}
          </ul>
        `;
      }
    }

    // --- Initialize Managers ---
    const debugManager = new DebugManager();
    window.debugLog = msg => debugManager.log(msg);

    // Add key listener for Glitch Stick
    window.addEventListener('keydown', e => {
      if (e.key === '-' && window.game?.player?.character) {
        window.game.player.character.relics = window.game.player.character.relics || {};
        window.game.player.character.relics.glitchStick = {
          id: 'glitchStick',
          name: 'Glitch Stick',
          level: 1,
          xp: 0,
          xpToNextLevel: 100,
          abilities: {
            glitch: {
              name: 'Glitch',
              description: 'Temporarily glitch the game',
              cooldown: 30,
              lastUsed: 0
            }
          }
        };
        debugManager.log('Glitch Stick added!');
      }
    });

    // Ensure portrait animation is set up when menu is opened
   // window.menuManager.overlay.addEventListener('transitionend', () => {
  //    if (window.menuManager.overlay.classList.contains('open')) {
  //      window.menuManager.startPortraitAnimation();
 //    }
 //   });

    // --- Debug Overlay ---
    const debugOverlay = document.getElementById('debug-overlay');
    const debugContent = document.getElementById('debug-content');
    const debugCloseBtn = document.getElementById('debug-close-btn');
    let debugVisible = false;

    window.debugLog = function(msg) {
      if (!debugContent) return;
      const p = document.createElement('div');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      debugContent.appendChild(p);
      debugContent.scrollTop = debugContent.scrollHeight;
    };

    function updateDebugOverlay(lastKey) {
      const menuOpen = document.getElementById('menu-overlay').classList.contains('open');
      const player = window.game?.player?.character;
      debugContent.innerHTML = `
        <b>Menu Open:</b> ${menuOpen}<br>
        <b>Last Key:</b> ${lastKey || ''}<br>
        <b>Relics:</b><br>
        <ul class="debug-list">
          ${player ? Object.values(player.relics).map(r => `<li>${r.name} (id: ${r.id}, lvl: ${r.level}, xp: ${r.xp}/${r.xpToNextLevel})</li>`).join('') : '<li>None</li>'}
        </ul>
      `;
    }

    debugCloseBtn.onclick = () => { debugOverlay.style.display = 'none'; debugVisible = false; };

    // Add keyboard shortcut for debug overlay
    window.addEventListener('keydown', e => {
      if (e.key === '`' || e.key === '~') {
        debugVisible = !debugVisible;
        debugOverlay.style.display = debugVisible ? 'block' : 'none';
        updateDebugOverlay(e.key);
      }
    });

    // Ensure a single, global MenuManager instance is available before any UI or event handler uses it
    window.addEventListener('DOMContentLoaded', function() {
      // ... other setup ...
      // Defensive guard for game and player
      if (window.game && window.game.player) {
        if (!window.menuManager) {
          window.menuManager = new MenuManager();
          // Set up party members (for now, just the player character)
          window.menuManager.partyMembers = [window.game.player.character];
          window.menuManager.partyMembers.forEach(member => {
            if (member.name === 'Hazel') {
              member.portraitFrames = hazelFrames;
            } else if (!Array.isArray(member.portraitFrames)) {
              // Set a default or fallback portraitFrames for other characters if needed
              member.portraitFrames = hazelFrames;
            }
          });
          window.menuManager.partyIndex = 0;
          window.menuManager.updatePartyNav();
        }
      }
      // Defensive check for overlay
      if (window.menuManager && window.menuManager.overlay) {
        window.menuManager.overlay.addEventListener('transitionend', () => {
          if (window.menuManager.overlay.classList.contains('open')) {
            window.menuManager.startPortraitAnimation();
          }
        });
      }
    });
  </script>
</body>
</html>
